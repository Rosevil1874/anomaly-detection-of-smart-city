# 全区10天数据分析

## 代码使用

main.py：主函数。

**数据处理：**
- dateparser.py：根据不同情况进行日期时间解析的几个函数；

- preprocess.py：数据预处理
	- 读取所有原文件，并聚合为同一个文件；
	- 将数据按照地址分解为小的独立的csv文件；
	- 删除同一设备在15秒内同一状态的数据；
	- 数据缺失的状态（主要是超时报警和报警解除）补充。

- counters.py：以各种时间维度计算设备各种状态出现的次数，进行数据格式转换；
	- 计算单元设备每小时/每日开门次数；
	- 计算单元设备**每日**漏报次数(omission_requency)、误报次数（未发出警报却出现解除警报状态）；
	- 计算单元设备**总**漏报次数(omission_requency)、误报次数（未发出警报却出现解除警报状态）；
	- 计算单元设备**每日**开门次数open_frequency、漏报次数(omission_requency)、超时报警次数（正常解除报警的情况）timeout_frequency；
	- 计算单元设备**总**开门次数open_frequency、漏报次数(omission_requency)、超时报警次数（正常解除报警的情况）timeout_frequency；
	- 计算单元设备**总**开门次数(工作日工作时段，工作日夜间，周末日间，凌晨)；
	- 计算每个设备一天中**每个小时**正常开门的总次数并转化为CSV文件（0时到1时之间的算作1时，以此类推）；
	- 计算每个设备一周中**每天**正常开门的总次数并转化为CSV文件（0时到1时之间的算作1时，以此类推）；
	- 将逐小时数据**按天**分开成单独的csv文件，方便绘图；
	- 将逐天数据**按周**分开成单独的csv文件，方便绘图；
	- 提取出春节期间正常开门次数数据；
	- 计算每个设备“正常开门4-超时未关门报警6-开门状态0-报警解除7”事件的时长；

- plt_analysis.py：分不同的时间维度未各设备画出各种状态、规律图。**暂未修改使用**
	- 画出每个设备一天中每个小时对应的开门次数；
	- 画出每个设备一周中每天对应的开门次数；
	- 画出每个设备工作日/周末的一天开门次数模型；
	- 画出每个设备一周开门次数模型；
	- 每个设备的漏报、误报次数比较；
	- 画出每个设备一次超时事件开门时长1小时及以内（1-3小时，3-6小时，6-10，10小时以上）占比；
	- 计算所有设备一次超时事件开门时长占比并画出饼图	；
	- 画出每个设备春节期间每天开门次数图：

- statistical.py：算出一天中每小时/一周中每天的开门次数（最佳情况、上界、下界），保存数据并画出相应图示。


**聚类：**
- cluster.py： 层次聚类，以“工作日工作时段，工作日通勤时段，周末日间，凌晨”的开门次数作为属性进行对全区的每个小区划分。
- cluster1.py：DBSCAN聚类，属性同上。


**异常检测：**
- FFT.py：使用Airbnb的异常检测方案，使用原序列减去周期和趋势得到误差项，效果很差。（这个应该是我实现的问题，没搞懂FFT怎么弄的。。。）
- LSTM.py：使用LSTM模型对序列进行预测，并使用MAE和ME结合找出异常；




## 文件目录
1. code: 源码；

2. dataset: 数据集
	- origin：原始文件，几个excel，需合并；
	- gathered.csv：原始文件合并后的数据集；
	- gathered_units：从合并后的数据集中分出的单元门数据；
	- gathered_doors：从合并后的数据集中分出的帮扶门数据；
	- neighbors_units：按小区划分后的数据；
	- units: 每个小区按地址划分后的数据；
	- redundancy_deleted: 删除重复状态后的数据；
	- complete_units: 补充缺失状态后的数据；
3. counts: 数据统计计算
	- 1day_origin: 各设备每天的开门总次数；
	- 1day：将超过5天开门次数为0的设备剔除保存后的每天开门总次数（还未实现剔除，所以和上面是一样的）；
	- 1hour: 各设备每小时的开门总次数；
	- peer_day: 各设备每周中每天的开门总次数；
	- peer_hour: 各设备每天中每小时的开门总次数；
	- total_open_condition：每个小区中每个地址处分时段开门次数(工作日工作时段[10,17]，工作日夜间[5,9]、[18,23]，周末日间[5,23]，凌晨[0,4])；
	- total_open_condition.csv: 全区中每个小区分时段计算的各设备总开门次数(工作日工作时段，工作日夜间，周末日间，凌晨)；

4. clusters：包含聚类结果图和对应设备分类文件。
	- csv：聚类结果分类别保存成CSV文件；
	- imgs：聚类结果中每个类别作一张图保存；
	- daily_count：按聚类结果分类计算一天中每小时平均开门次数；
	- weekly_count：按聚类结果分类计算一周中每天平均开门次数；
	- statistical_model：按聚类结果找出每个类别对应的均值标准差模型；
	- plot_dendrogram.png：聚类层次图。

5. statistic_model：均值标准差模型
	- daily_workday：工作日一日模型
	- daily_weekend：周末一日模型
	- weekly: 一周模型

7. anomaly_result: 异常，暂未计算
	- daily: 异常日期
		- anomalies：FFT模型检测出的异常；
		- corr_anomalies：与均值标准差模型对比后的正确异常结果（即使用均值标准差也表现为异常的）；
		- corr_rate.csv：每个设备对应的正确率；
		- total.csv：所有异常汇总；
		- LSTM：使用LSTM检测异常的结果。
	- hourly: 异常日期时间
		- anomalies：FFT模型检测出的异常；
		- corr_anomalies：与均值标准差模型对比后的正确异常结果（即使用均值标准差也表现为异常的）；
		- corr_rate.csv：每个设备对应的正确率；
		- total.csv：所有异常汇总；
		- LSTM：使用LSTM检测异常的结果。
